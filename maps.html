<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NH Maps - NH Management System</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map {
            height: calc(100vh - 200px);
            min-height: 500px;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .map-controls {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .control-row {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        
        .map-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 1.25rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            z-index: 1000;
            max-width: 280px;
            border: 2px solid #000000;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            font-size: 14px;
        }
        
        .legend-item:last-child {
            margin-bottom: 0;
        }
        
        .legend-line {
            width: 35px;
            height: 4px;
            margin-right: 0.75rem;
            border-radius: 2px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .segment-info {
            padding: 0.5rem;
        }
        
        .segment-info h4 {
            margin: 0 0 0.5rem 0;
            color: var(--primary-color);
        }
        
        .segment-info p {
            margin: 0.25rem 0;
            font-size: 0.9rem;
        }
        
        .loading-map {
            text-align: center;
            padding: 2rem;
            color: var(--secondary-color);
        }
        
        /* Custom tooltip styles */
        .custom-tooltip {
            background-color: rgba(0, 0, 0, 0.95) !important;
            border: 2px solid white !important;
            border-radius: 6px !important;
            color: white !important;
            font-weight: bold !important;
            font-size: 13px !important;
            padding: 6px 10px !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
        }
        
        .custom-tooltip:before {
            border-top-color: rgba(0, 0, 0, 0.95) !important;
        }
        
        .segment-label {
            background: transparent !important;
            border: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <nav class="nav">
            <div class="nav-brand">
                <h2>üõ£Ô∏è NH Management System</h2>
            </div>
            <div class="nav-links">
                <a href="/dashboard.html">Dashboard</a>
                <a href="/segments.html">Segments</a>
                <a href="/maps.html" class="active">Maps</a>
                <a href="/reports.html">Reports</a>
                <a href="/validation.html">Validation</a>
                <a href="#" onclick="app.logout()">Logout</a>
            </div>
            <div class="user-info">
                <span id="userDisplay"></span>
            </div>
        </nav>

        <!-- Page Header -->
        <header class="page-header">
            <div>
                <h1>üó∫Ô∏è NH Route Maps</h1>
                <p>Visualize National Highway segments on interactive map</p>
            </div>
        </header>

        <!-- Map Controls -->
        <div class="map-controls">
            <div class="control-row">
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label class="form-label">Select NH</label>
                    <select class="form-control" id="nhSelect" onchange="loadNHSegments()">
                        <option value="">-- Select NH --</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1; min-width: 200px;">
                    <label class="form-label">Select Segment (Optional)</label>
                    <select class="form-control" id="segmentSelect" onchange="focusSegment()">
                        <option value="">-- All Segments --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-primary" onclick="drawRoute()">
                        üìç Show on Map
                    </button>
                </div>
                <div class="form-group">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-secondary" onclick="clearMap()">
                        üîÑ Clear Map
                    </button>
                </div>
            </div>
        </div>

        <!-- Map Container -->
        <div style="position: relative;">
            <div id="map"></div>
            <div class="map-legend">
                <h4 style="margin-top: 0; color: var(--primary-color);">üó∫Ô∏è Map Legend</h4>
                <div class="legend-item">
                    <div class="legend-line" style="background-color: #000000; height: 4px;"></div>
                    <span><strong>Selected NH Route</strong></span>
                </div>
                <div class="legend-item">
                    <div style="width: 12px; height: 12px; background-color: #16a34a; border-radius: 50%; margin-right: 0.5rem; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.3);"></div>
                    <span>Segment Start</span>
                </div>
                <div class="legend-item">
                    <div style="width: 12px; height: 12px; background-color: #dc2626; border-radius: 50%; margin-right: 0.5rem; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.3);"></div>
                    <span>Segment End</span>
                </div>
                <div class="legend-item">
                    <div style="width: 12px; height: 12px; background-color: #8b5cf6; border-radius: 50%; margin-right: 0.5rem; border: 2px solid #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.3);"></div>
                    <span>Lane Config Point</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/static/js/app.js"></script>
    <script>
        // Use the global app instance from app.js
        let map;
        let routeLayer;
        let markersLayer;
        let configLayer;
        let currentSegments = [];
        let currentNH = null;
        let segmentDetailsCache = {};

        // Known coordinates for major cities in Tamil Nadu (for precise mapping)
        const knownLocations = {
            'chennai': [13.0827, 80.2707],
            'madurai': [9.9252, 78.1198],
            'trichy': [10.7905, 78.7047],
            'tiruchirappalli': [10.7905, 78.7047],
            'salem': [11.6643, 78.1460],
            'coimbatore': [11.0168, 76.9558],
            'tirunelveli': [8.7139, 77.7567],
            'erode': [11.3410, 77.7172],
            'vellore': [12.9165, 79.1325],
            'thoothukudi': [8.7642, 78.1348],
            'tuticorin': [8.7642, 78.1348],
            'dindigul': [10.3673, 77.9803],
            'thanjavur': [10.7870, 79.1378],
            'ranipet': [12.9249, 79.3308],
            'tiruppur': [11.1085, 77.3411],
            'nagercoil': [8.1790, 77.4345],
            'karur': [10.9601, 78.0766],
            'kanchipuram': [12.8342, 79.7036],
            'cuddalore': [11.7480, 79.7714],
            'kumbakonam': [10.9617, 79.3881]
        };

        // Initialize map
        function initMap() {
            // Create map centered on Tamil Nadu
            map = L.map('map').setView([11.1271, 78.6569], 7);

            // Add OpenStreetMap tiles with better visibility
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19,
                minZoom: 6
            }).addTo(map);

            // Initialize layer groups
            routeLayer = L.layerGroup().addTo(map);
            markersLayer = L.layerGroup().addTo(map);
            configLayer = L.layerGroup().addTo(map);

            console.log('Map initialized');
        }


        // Load NHs into dropdown
        async function loadNHs() {
            try {
                console.log('Loading NHs...');
                app.showLoading();
                const result = await app.getAllNHs();
                console.log('Raw NH result:', result);
                
                const nhs = result.data || [];
                console.log('NHs loaded:', nhs.length, 'items');
                
                const select = document.getElementById('nhSelect');
                if (!select) {
                    console.error('NH select element not found!');
                    app.hideLoading();
                    return;
                }
                
                select.innerHTML = '<option value="">-- Select NH --</option>' +
                    nhs.map(nh => `<option value="${nh.nh_id}">${nh.nh_number} - ${nh.nh_name}</option>`).join('');
                
                app.hideLoading();
                
                if (nhs.length === 0) {
                    app.showAlert('No NHs found in database', 'warning');
                }
            } catch (error) {
                console.error('Error loading NHs:', error);
                app.hideLoading();
                app.showAlert('Error loading NHs: ' + error.message, 'error');
            }
        }

        // Load segments for selected NH
        async function loadNHSegments() {
            const nhId = document.getElementById('nhSelect').value;
            const segmentSelect = document.getElementById('segmentSelect');
            
            if (!nhId) {
                segmentSelect.innerHTML = '<option value="">-- All Segments --</option>';
                currentSegments = [];
                return;
            }

            try {
                console.log('Loading segments for NH:', nhId);
                app.showLoading();
                const result = await app.getSegments();
                console.log('Raw segments result:', result);
                
                const segments = result.data || [];
                currentSegments = segments.filter(s => s.nh_id == nhId);
                
                console.log('Filtered segments for NH', nhId, ':', currentSegments.length, 'segments');
                segmentSelect.innerHTML = '<option value="">-- All Segments --</option>' +
                    currentSegments.map((s, idx) => 
                        `<option value="${idx}">${s.segment_name} (${s.start_chainage} - ${s.end_chainage} km)</option>`
                    ).join('');
                
                app.hideLoading();
                
                if (currentSegments.length === 0) {
                    app.showAlert('No segments found for this NH', 'info');
                }
            } catch (error) {
                console.error('Error loading segments:', error);
                app.hideLoading();
                app.showAlert('Error loading segments: ' + error.message, 'error');
            }
        }

        // Draw route on map with precise segment and configuration data
        async function drawRoute() {
            const nhId = document.getElementById('nhSelect').value;
            
            if (!nhId) {
                app.showAlert('Please select an NH first', 'warning');
                return;
            }

            const nhSelect = document.getElementById('nhSelect');
            const selectedOption = nhSelect.options[nhSelect.selectedIndex];
            const nhNumber = selectedOption.text.split(' - ')[0];
            
            currentNH = nhNumber;

            try {
                app.showLoading();
                
                // Clear existing layers
                routeLayer.clearLayers();
                markersLayer.clearLayers();
                configLayer.clearLayers();

                if (currentSegments.length === 0) {
                    app.showAlert('No segments found for this NH', 'warning');
                    app.hideLoading();
                    return;
                }

                // Fetch detailed configuration data for each segment
                await fetchSegmentDetails();

                // Plot segments with precise coordinates
                await plotPreciseRoute();

                app.hideLoading();
                app.showAlert(`Route for ${nhNumber} displayed with ${currentSegments.length} segments`, 'success');

            } catch (error) {
                app.hideLoading();
                console.error('Error drawing route:', error);
                app.showAlert('Error displaying route: ' + error.message, 'error');
            }
        }

        // Fetch detailed configuration data for all segments
        async function fetchSegmentDetails() {
            for (const segment of currentSegments) {
                try {
                    const details = await app.apiCall(`/api/segments/${segment.segment_id}/details`, 'GET');
                    segmentDetailsCache[segment.segment_id] = details;
                } catch (error) {
                    console.error(`Error fetching details for segment ${segment.segment_id}:`, error);
                    segmentDetailsCache[segment.segment_id] = [];
                }
            }
        }

        // Extract city names from segment names for geocoding
        function extractLocations(segmentName) {
            const locations = [];
            const name = segmentName.toLowerCase();
            
            // Check against known locations
            for (const [city, coords] of Object.entries(knownLocations)) {
                if (name.includes(city)) {
                    locations.push({ name: city, coords: coords });
                }
            }
            
            return locations;
        }

        // Plot route with precise segment coordinates
        async function plotPreciseRoute() {
            const allCoords = [];
            const segmentMarkers = [];

            // Process each segment
            for (let i = 0; i < currentSegments.length; i++) {
                const segment = currentSegments[i];
                
                // Use actual GPS coordinates from database
                const hasCoords = segment.start_latitude && segment.start_longitude && 
                                 segment.end_latitude && segment.end_longitude;
                
                if (hasCoords) {
                    // Use database coordinates
                    const startCoords = [parseFloat(segment.start_latitude), parseFloat(segment.start_longitude)];
                    const endCoords = [parseFloat(segment.end_latitude), parseFloat(segment.end_longitude)];
                    
                    // Store coordinates
                    segment._startCoords = startCoords;
                    segment._endCoords = endCoords;
                    
                    allCoords.push(startCoords, endCoords);
                    
                    // Draw segment line in BLACK color
                    const segmentLine = L.polyline([startCoords, endCoords], {
                        color: '#000000',  // Black color for selected NH
                        weight: 5,
                        opacity: 0.8,
                        smoothFactor: 1
                    }).addTo(routeLayer);
                    
                    // Add tooltip to segment line
                    segmentLine.bindTooltip(segment.segment_name, {
                        permanent: false,
                        direction: 'center',
                        className: 'custom-tooltip'
                    });

                    // Add start marker with larger size
                    const startMarker = L.circleMarker(startCoords, {
                        radius: 10,
                        fillColor: '#16a34a',
                        color: '#fff',
                        weight: 3,
                        opacity: 1,
                        fillOpacity: 1
                    }).addTo(markersLayer);

                    startMarker.bindPopup(createSegmentPopup(segment, 'start'));

                    // Add end marker with larger size
                    const endMarker = L.circleMarker(endCoords, {
                        radius: 10,
                        fillColor: '#dc2626',
                        color: '#fff',
                        weight: 3,
                        opacity: 1,
                        fillOpacity: 1
                    }).addTo(markersLayer);

                    endMarker.bindPopup(createSegmentPopup(segment, 'end'));

                    // Add mid-point label with NH info
                    const midLat = (startCoords[0] + endCoords[0]) / 2;
                    const midLng = (startCoords[1] + endCoords[1]) / 2;
                    
                    const labelMarker = L.marker([midLat, midLng], {
                        icon: L.divIcon({
                            className: 'segment-label',
                            html: `<div style="background-color: rgba(0, 0, 0, 0.85); color: white; padding: 8px 14px; border-radius: 6px; font-weight: bold; white-space: nowrap; box-shadow: 0 3px 6px rgba(0,0,0,0.4); font-size: 13px; border: 2px solid #fff;">${currentNH} - ${segment.segment_name}<br><small style="font-size: 11px;">üìè ${segment.start_chainage} - ${segment.end_chainage} km</small></div>`,
                            iconSize: [180, 50]
                        })
                    }).addTo(markersLayer);

                    labelMarker.bindPopup(createSegmentPopup(segment, 'info'));

                    // Plot configuration points along the segment
                    await plotConfigurationPoints(segment, startCoords, endCoords);

                } else {
                    console.warn(`Segment ${segment.segment_id} (${segment.segment_name}) has no GPS coordinates`);
                }
            }

            // Fit map to show all markers with animation and proper padding
            if (allCoords.length > 0) {
                const bounds = L.latLngBounds(allCoords);
                map.fitBounds(bounds, {
                    padding: [50, 50],  // Add padding around bounds
                    maxZoom: 10,        // Don't zoom in too much
                    animate: true,      // Smooth animation
                    duration: 1.5       // Animation duration in seconds
                });
            } else {
                // If no coordinates found, show alert
                app.showAlert('No GPS coordinates found for this NH. Please add latitude/longitude to segments in the Segments tab.', 'warning');
            }
        }

        // Plot configuration points along a segment
        async function plotConfigurationPoints(segment, startCoords, endCoords) {
            const details = segmentDetailsCache[segment.segment_id] || [];
            
            if (details.length === 0) return;

            const segmentLength = parseFloat(segment.end_chainage) - parseFloat(segment.start_chainage);
            
            details.forEach(detail => {
                const detailStart = parseFloat(detail.start_chainage);
                const detailEnd = parseFloat(detail.end_chainage);
                const detailMid = (detailStart + detailEnd) / 2;
                
                // Calculate position ratio along segment
                const ratio = (detailMid - parseFloat(segment.start_chainage)) / segmentLength;
                
                // Interpolate coordinates
                const lat = startCoords[0] + (endCoords[0] - startCoords[0]) * ratio;
                const lng = startCoords[1] + (endCoords[1] - startCoords[1]) * ratio;
                
                // Add configuration marker
                const configMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'config-marker',
                        html: `<div style="background-color: #8b5cf6; color: white; padding: 4px 8px; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">C</div>`,
                        iconSize: [24, 24]
                    })
                }).addTo(configLayer);

                configMarker.bindPopup(`
                    <div class="segment-info">
                        <h4 style="color: #8b5cf6;">üìã ${detail.config_name}</h4>
                        <p><strong>Chainage:</strong> ${detail.start_chainage} - ${detail.end_chainage} km</p>
                        <p><strong>Length:</strong> ${(detailEnd - detailStart).toFixed(3)} km</p>
                        <p><strong>Segment:</strong> ${segment.segment_name}</p>
                        ${detail.remarks ? `<p><strong>Remarks:</strong> ${detail.remarks}</p>` : ''}
                    </div>
                `);
            });
        }

        // Create detailed popup for segment
        function createSegmentPopup(segment, type) {
            const details = segmentDetailsCache[segment.segment_id] || [];
            const totalLength = parseFloat(segment.end_chainage) - parseFloat(segment.start_chainage);
            const configuredLength = details.reduce((sum, d) => 
                sum + (parseFloat(d.end_chainage) - parseFloat(d.start_chainage)), 0
            );
            const coverage = totalLength > 0 ? (configuredLength / totalLength * 100).toFixed(1) : 0;

            let icon = 'üìç';
            if (type === 'start') icon = 'üü¢';
            else if (type === 'end') icon = 'üî¥';
            else if (type === 'info') icon = 'üìä';

            return `
                <div class="segment-info">
                    <h4>${icon} ${segment.segment_name}</h4>
                    <p><strong>NH:</strong> ${segment.nh_number}</p>
                    <p><strong>Division:</strong> ${segment.division_name}</p>
                    <p><strong>Chainage Range:</strong> ${segment.start_chainage} - ${segment.end_chainage} km</p>
                    <p><strong>Total Length:</strong> ${totalLength.toFixed(3)} km</p>
                    <p><strong>Configurations:</strong> ${details.length}</p>
                    <p><strong>Coverage:</strong> <span style="color: ${coverage >= 100 ? '#16a34a' : coverage >= 50 ? '#f59e0b' : '#dc2626'}; font-weight: bold;">${coverage}%</span></p>
                    ${details.length > 0 ? `
                        <hr style="margin: 0.5rem 0;">
                        <p style="font-size: 0.85rem; margin-top: 0.5rem;"><strong>Configurations:</strong></p>
                        <ul style="margin: 0.25rem 0; padding-left: 1.5rem; font-size: 0.8rem;">
                            ${details.slice(0, 3).map(d => 
                                `<li>${d.config_name} (${d.start_chainage}-${d.end_chainage} km)</li>`
                            ).join('')}
                            ${details.length > 3 ? `<li><em>...and ${details.length - 3} more</em></li>` : ''}
                        </ul>
                    ` : ''}
                </div>
            `;
        }

        // Geocode segment and plot if coordinates not found
        async function geocodeAndPlot(segment) {
            try {
                const query = `${segment.segment_name}, Tamil Nadu, India`;
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1`
                );
                const data = await response.json();

                if (data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    segment._coords = [lat, lon];

                    const marker = L.circleMarker([lat, lon], {
                        radius: 8,
                        fillColor: '#3b82f6',
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(markersLayer);

                    marker.bindPopup(createSegmentPopup(segment, 'geocoded'));
                }

                // Rate limit delay
                await new Promise(resolve => setTimeout(resolve, 1000));
            } catch (error) {
                console.error('Geocoding error:', error);
            }
        }

        // Focus on specific segment
        function focusSegment() {
            const segmentIdx = document.getElementById('segmentSelect').value;
            
            if (!segmentIdx) return;

            const segment = currentSegments[segmentIdx];
            
            // Clear config layer and redraw for this segment only
            configLayer.clearLayers();
            
            if (segment._startCoords && segment._endCoords) {
                // Zoom to segment with animation
                const bounds = L.latLngBounds([segment._startCoords, segment._endCoords]);
                map.fitBounds(bounds, {
                    padding: [80, 80],
                    maxZoom: 12,
                    animate: true,
                    duration: 1.0
                });
                
                // Highlight the segment with thicker red line
                const highlightLine = L.polyline([segment._startCoords, segment._endCoords], {
                    color: '#dc2626',
                    weight: 8,
                    opacity: 0.9,
                    dashArray: '10, 5'
                }).addTo(configLayer);

                // Plot configuration points for this segment
                plotConfigurationPoints(segment, segment._startCoords, segment._endCoords);
                
                // Show popup at midpoint
                const midLat = (segment._startCoords[0] + segment._endCoords[0]) / 2;
                const midLng = (segment._startCoords[1] + segment._endCoords[1]) / 2;
                
                L.popup()
                    .setLatLng([midLat, midLng])
                    .setContent(createSegmentPopup(segment, 'focus'))
                    .openOn(map);
                    
            } else if (segment._coords) {
                map.setView(segment._coords, 12, {
                    animate: true,
                    duration: 1.0
                });
                
                const marker = L.circleMarker(segment._coords, {
                    radius: 15,
                    fillColor: '#dc2626',
                    color: '#fff',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(configLayer);

                marker.bindPopup(createSegmentPopup(segment, 'focus')).openPopup();
            }
        }

        // Clear map
        function clearMap() {
            routeLayer.clearLayers();
            markersLayer.clearLayers();
            configLayer.clearLayers();
            map.setView([11.1271, 78.6569], 7);
            document.getElementById('nhSelect').value = '';
            document.getElementById('segmentSelect').innerHTML = '<option value="">-- All Segments --</option>';
            currentSegments = [];
            currentNH = null;
            segmentDetailsCache = {};
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            // Check authentication
            if (!app.isAuthenticated()) {
                console.log('Not authenticated, redirecting to login...');
                window.location.href = '/index.html';
                return;
            }

            // Display user info
            const user = app.user;
            if (user) {
                const userDisplay = document.getElementById('userDisplay');
                if (userDisplay) {
                    userDisplay.textContent = user.full_name || user.username;
                }
            }

            // Initialize map
            console.log('Initializing map...');
            try {
                initMap();
                console.log('Map initialized successfully');
            } catch (error) {
                console.error('Error initializing map:', error);
                app.showAlert('Error initializing map: ' + error.message, 'error');
            }

            // Load NHs
            await loadNHs();
        });
    </script>
</body>
</html>
