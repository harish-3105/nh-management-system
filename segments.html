<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Segments - NH Management System</title>
    <link rel="stylesheet" href="static/css/style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="dashboard.html" class="navbar-brand">
                <span class="navbar-brand-icon">üõ£Ô∏è</span>
                <span>NH Management</span>
            </a>
            
            <ul class="navbar-menu">
                <li class="navbar-item"><a href="dashboard.html">Dashboard</a></li>
                <li class="navbar-item"><a href="segments.html" style="color: var(--primary-color);">Segments</a></li>
                <li class="navbar-item"><a href="maps.html">Maps</a></li>
                <li class="navbar-item"><a href="reports.html">Reports</a></li>
                <li class="navbar-item"><a href="validation.html">Validation</a></li>
            </ul>

            <div class="navbar-user">
                <div class="user-info">
                    <span class="user-name" id="userName"></span>
                    <span class="user-role" id="userRole"></span>
                </div>
                <div class="user-avatar" id="userAvatar"></div>
                <button class="btn btn-secondary btn-sm" onclick="app.logout()">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <div id="alertContainer"></div>

        <div class="dashboard-header">
            <h1 class="dashboard-title">NH Segments</h1>
            <p class="dashboard-subtitle">Manage National Highway segments and configurations</p>
        </div>

        <!-- Segments List -->
        <div class="card">
            <div class="card-header flex-between">
                <h2 class="card-title">Segment List</h2>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <input type="text" id="searchInput" class="form-control" 
                           placeholder="Search segments..." 
                           style="max-width: 300px;"
                           oninput="filterSegments()">
                    <button class="btn btn-primary" onclick="showAddSegmentModal()">
                        + Add New Segment
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table class="table" id="segmentsTable">
                        <thead>
                            <tr>
                                <th>NH Number</th>
                                <th>Description</th>
                                <th>Division Office</th>
                                <th>Start Chainage</th>
                                <th>End Chainage</th>
                                <th>Length (km)</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="segmentsTableBody">
                            <tr>
                                <td colspan="8" class="text-center">
                                    <div class="loading-spinner" style="margin: 2rem auto;"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Segment Details Modal -->
    <div class="modal" id="detailsModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                    <h2 class="modal-title" id="modalTitle">Segment Details</h2>
                    <button class="btn btn-sm btn-primary" onclick="editSegmentFromDetails()" title="Edit Segment">
                        ‚úèÔ∏è Edit Segment Info
                    </button>
                </div>
                <button class="modal-close" onclick="app.hideModal('detailsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Segment Info -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">Segment Information</h3>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div>
                                <strong>NH Number:</strong>
                                <p id="detailNHNumber">-</p>
                            </div>
                            <div>
                                <strong>Division Office:</strong>
                                <p id="detailOffice">-</p>
                            </div>
                            <div>
                                <strong>Start Chainage:</strong>
                                <p id="detailStart">-</p>
                            </div>
                            <div>
                                <strong>End Chainage:</strong>
                                <p id="detailEnd">-</p>
                            </div>
                            <div>
                                <strong>Length:</strong>
                                <p id="detailLength">-</p>
                            </div>
                            <div>
                                <strong>Status:</strong>
                                <p id="detailStatus">-</p>
                            </div>
                            <div>
                                <strong>üìç Start Latitude:</strong>
                                <p id="detailStartLat">-</p>
                            </div>
                            <div>
                                <strong>üìç Start Longitude:</strong>
                                <p id="detailStartLng">-</p>
                            </div>
                            <div>
                                <strong>üìç End Latitude:</strong>
                                <p id="detailEndLat">-</p>
                            </div>
                            <div>
                                <strong>üìç End Longitude:</strong>
                                <p id="detailEndLng">-</p>
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <strong>Description:</strong>
                                <p id="detailDescription">-</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Road Configurations -->
                <div class="card">
                    <div class="card-header flex-between">
                        <h3 class="card-title">Road Configurations</h3>
                        <button class="btn btn-primary btn-sm" onclick="showAddDetailModal()">
                            + Add Configuration
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Configuration</th>
                                        <th>Start (km)</th>
                                        <th>End (km)</th>
                                        <th>Length (km)</th>
                                        <th>Remarks</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="detailsTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="coverageInfo" style="margin-top: 1rem; padding: 1rem; background: var(--light); border-radius: 0.5rem;">
                            <strong>Coverage:</strong> <span id="coveragePercent">-</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="app.hideModal('detailsModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Detail Modal -->
    <div class="modal" id="addDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="addDetailTitle">Add Road Configuration</h2>
                <button class="modal-close" onclick="app.hideModal('addDetailModal')">&times;</button>
            </div>
            <form id="detailForm" onsubmit="handleDetailSubmit(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Configuration Type *</label>
                        <select class="form-control" id="configId" required>
                            <option value="">Select configuration...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Chainage (km) *</label>
                        <input type="number" step="0.001" class="form-control" id="startChainage" 
                               required min="0" max="10000">
                        <small style="color: var(--secondary-color); display: block; margin-top: 0.25rem;">
                            <strong>Valid range:</strong> <span id="validRangeStart">-</span> to <span id="validRangeEnd">-</span> km
                        </small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Chainage (km) *</label>
                        <input type="number" step="0.001" class="form-control" id="endChainage" 
                               required min="0" max="10000">
                        <small style="color: var(--secondary-color); display: block; margin-top: 0.25rem;">
                            Must be greater than start chainage
                        </small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Remarks</label>
                        <textarea class="form-control" id="remarks" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="app.hideModal('addDetailModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitDetailBtn">Add Configuration</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Segment Modal -->
    <div class="modal" id="addSegmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="segmentModalTitle">Add New Segment</h2>
                <button class="modal-close" onclick="app.hideModal('addSegmentModal')">&times;</button>
            </div>
            <form id="segmentForm" onsubmit="handleSegmentSubmit(event)">
                <input type="hidden" id="segmentId" value="">
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">NH Number *</label>
                        <select class="form-control" id="segmentNhId" required>
                            <option value="">Select NH...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Division Office *</label>
                        <select class="form-control" id="segmentDivisionId" required>
                            <option value="">Select Division...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Segment Description *</label>
                        <input type="text" class="form-control" id="segmentDescription" required 
                               placeholder="e.g., Salem to Namakkal">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Chainage (km) *</label>
                        <input type="number" step="0.001" class="form-control" id="segmentStartChainage" 
                               required min="0" max="10000" placeholder="0.000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Chainage (km) *</label>
                        <input type="number" step="0.001" class="form-control" id="segmentEndChainage" 
                               required min="0" max="10000" placeholder="0.000">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Start Latitude</label>
                            <input type="number" step="0.000001" class="form-control" id="segmentStartLatitude" 
                                   min="-90" max="90" placeholder="e.g., 11.127123">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Start Longitude</label>
                            <input type="number" step="0.000001" class="form-control" id="segmentStartLongitude" 
                                   min="-180" max="180" placeholder="e.g., 78.656891">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">End Latitude</label>
                            <input type="number" step="0.000001" class="form-control" id="segmentEndLatitude" 
                                   min="-90" max="90" placeholder="e.g., 11.234567">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Longitude</label>
                            <input type="number" step="0.000001" class="form-control" id="segmentEndLongitude" 
                                   min="-180" max="180" placeholder="e.g., 78.789012">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status *</label>
                        <select class="form-control" id="segmentStatus" required>
                            <option value="active">Active</option>
                            <option value="draft">Draft</option>
                            <option value="archived">Archived</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="app.hideModal('addSegmentModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitSegmentBtn">Add Segment</button>
                </div>
            </form>
        </div>
    </div>

    <script src="static/js/app.js"></script>
    <script>
        if (!app.isAuthenticated()) window.location.href = '/';
        
        document.getElementById('userName').textContent = app.user.full_name;
        document.getElementById('userRole').textContent = app.user.role === 'central' ? 'Central Authority' : app.user.office_name;
        document.getElementById('userAvatar').textContent = app.getUserInitials();

        let laneConfigCounter = 0;

        let allSegments = [];
        let currentSegment = null;
        let allConfigurations = [];
        let allNHs = [];
        let allDivisions = [];

        async function loadPage() {
            app.showLoading();
            try {
                console.log('Starting to load page data...');
                const [segmentsData, configsData, nhsData, divisionsData] = await Promise.all([
                    app.getSegments(),
                    app.getConfigurations(),
                    app.getAllNHs(),
                    app.apiCall('/api/divisions', 'GET')
                ]);
                
                console.log('Raw API responses:', {
                    segmentsData,
                    configsData,
                    nhsData,
                    divisionsData
                });
                
                allSegments = segmentsData?.data || [];
                allConfigurations = configsData?.data || [];
                allNHs = nhsData?.data || [];
                allDivisions = divisionsData?.data || [];
                
                console.log('Loaded data:', {
                    segments: allSegments.length,
                    configurations: allConfigurations.length,
                    nhs: allNHs.length,
                    divisions: allDivisions.length
                });
                
                loadSegmentsTable(allSegments);
                populateConfigSelect();
                populateNHSelect();
                populateDivisionSelect();
                
                app.hideLoading();
            } catch (error) {
                console.error('Error loading page:', error);
                app.hideLoading();
                app.showAlert('Error loading data: ' + error.message, 'error');
            }
        }

        function populateNHSelect() {
            const select = document.getElementById('segmentNhId');
            if (!select) return;
            select.innerHTML = '<option value="">Select NH...</option>';
            allNHs.forEach(nh => {
                select.innerHTML += `<option value="${nh.nh_id}">${nh.nh_number} - ${nh.nh_name}</option>`;
            });
        }

        function populateDivisionSelect() {
            const select = document.getElementById('segmentDivisionId');
            if (!select) return;
            select.innerHTML = '<option value="">Select Division...</option>';
            allDivisions.forEach(div => {
                select.innerHTML += `<option value="${div.division_id}">${div.office_name} (${div.division_name})</option>`;
            });
        }

        function loadSegmentsTable(segments) {
            const tbody = document.getElementById('segmentsTableBody');
            
            if (segments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No segments found</td></tr>';
                return;
            }
            
            tbody.innerHTML = segments.map(seg => {
                const length = (parseFloat(seg.end_chainage) - parseFloat(seg.start_chainage)).toFixed(3);
                return `
                <tr>
                    <td><strong>${seg.nh_number}</strong></td>
                    <td>${seg.segment_description}</td>
                    <td>${seg.office_name}</td>
                    <td>${seg.start_chainage}</td>
                    <td>${seg.end_chainage}</td>
                    <td><strong>${length}</strong></td>
                    <td><span class="badge badge-success">${seg.status}</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewDetails(${seg.segment_id})" title="View Details">
                            üëÅÔ∏è View
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="editSegment(${seg.segment_id})" title="Edit Segment">
                            ‚úèÔ∏è Edit
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSegment(${seg.segment_id}, '${seg.nh_number}')" title="Delete Segment">
                            üóëÔ∏è Delete
                        </button>
                    </td>
                </tr>
            `}).join('');
        }

        function filterSegments() {
            const search = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!search) {
                // If search is empty, show all segments
                loadSegmentsTable(allSegments);
                return;
            }
            
            const filtered = allSegments.filter(seg => {
                // Safely check each field
                const nhNumber = (seg.nh_number || '').toString().toLowerCase();
                const description = (seg.segment_description || '').toString().toLowerCase();
                const officeName = (seg.office_name || '').toString().toLowerCase();
                const startChainage = (seg.start_chainage || '').toString().toLowerCase();
                const endChainage = (seg.end_chainage || '').toString().toLowerCase();
                const status = (seg.status || '').toString().toLowerCase();
                
                return nhNumber.includes(search) ||
                       description.includes(search) ||
                       officeName.includes(search) ||
                       startChainage.includes(search) ||
                       endChainage.includes(search) ||
                       status.includes(search);
            });
            
            loadSegmentsTable(filtered);
        }

        async function viewDetails(segmentId) {
            app.showLoading();
            try {
                const [segmentData, detailsData] = await Promise.all([
                    app.getSegmentDetails(segmentId),
                    app.getRoadDetails(segmentId)
                ]);
                
                currentSegment = segmentData.data;
                const details = detailsData.data || [];
                
                // Populate segment info
                const segmentLength = (parseFloat(currentSegment.end_chainage) - parseFloat(currentSegment.start_chainage)).toFixed(3);
                
                document.getElementById('modalTitle').textContent = `${currentSegment.nh_number} - ${currentSegment.segment_description}`;
                document.getElementById('detailNHNumber').textContent = currentSegment.nh_number;
                document.getElementById('detailOffice').textContent = currentSegment.office_name;
                document.getElementById('detailStart').textContent = `${currentSegment.start_chainage} km`;
                document.getElementById('detailEnd').textContent = `${currentSegment.end_chainage} km`;
                document.getElementById('detailLength').textContent = `${segmentLength} km`;
                document.getElementById('detailStatus').innerHTML = `<span class="badge badge-success">${currentSegment.status}</span>`;
                document.getElementById('detailDescription').textContent = currentSegment.segment_description;
                
                // Populate latitude and longitude
                document.getElementById('detailStartLat').textContent = currentSegment.start_latitude || 'Not Set';
                document.getElementById('detailStartLng').textContent = currentSegment.start_longitude || 'Not Set';
                document.getElementById('detailEndLat').textContent = currentSegment.end_latitude || 'Not Set';
                document.getElementById('detailEndLng').textContent = currentSegment.end_longitude || 'Not Set';
                
                // Load road details
                loadDetailsTable(details);
                
                // Calculate coverage
                const totalCovered = details.reduce((sum, d) => {
                    const length = parseFloat(d.end_chainage) - parseFloat(d.start_chainage);
                    return sum + length;
                }, 0);
                const coverage = (totalCovered / parseFloat(segmentLength) * 100).toFixed(2);
                document.getElementById('coveragePercent').innerHTML = `<strong>${coverage}%</strong> (${totalCovered.toFixed(3)} km of ${segmentLength} km)`;
                
                app.showModal('detailsModal');
                app.hideLoading();
            } catch (error) {
                app.hideLoading();
                app.showAlert('Error loading details: ' + error.message, 'error');
            }
        }

        function loadDetailsTable(details) {
            const tbody = document.getElementById('detailsTableBody');
            
            if (details.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No configurations added yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = details.map(detail => {
                const length = (parseFloat(detail.end_chainage) - parseFloat(detail.start_chainage)).toFixed(3);
                return `
                <tr>
                    <td><span class="badge badge-primary">${detail.config_name}</span></td>
                    <td>${detail.start_chainage}</td>
                    <td>${detail.end_chainage}</td>
                    <td><strong>${length}</strong></td>
                    <td>${detail.remarks || '-'}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteDetail(${detail.detail_id})">
                            Delete
                        </button>
                    </td>
                </tr>
            `}).join('');
        }

        function populateConfigSelect() {
            const select = document.getElementById('configId');
            if (!select) return;
            select.innerHTML = '<option value="">Select configuration...</option>' +
                allConfigurations.map(c => `<option value="${c.config_id}">${c.config_name}</option>`).join('');
        }

        function showAddDetailModal() {
            document.getElementById('addDetailTitle').textContent = 'Add Road Configuration';
            document.getElementById('detailForm').reset();
            document.getElementById('validRangeStart').textContent = currentSegment.start_chainage;
            document.getElementById('validRangeEnd').textContent = currentSegment.end_chainage;
            
            // Set min/max attributes dynamically
            document.getElementById('startChainage').setAttribute('min', currentSegment.start_chainage);
            document.getElementById('startChainage').setAttribute('max', currentSegment.end_chainage);
            document.getElementById('endChainage').setAttribute('min', currentSegment.start_chainage);
            document.getElementById('endChainage').setAttribute('max', currentSegment.end_chainage);
            
            app.showModal('addDetailModal');
        }

        async function handleDetailSubmit(event) {
            event.preventDefault();
            
            const data = {
                segment_id: currentSegment.segment_id,
                config_id: parseInt(document.getElementById('configId').value),
                start_chainage: parseFloat(document.getElementById('startChainage').value),
                end_chainage: parseFloat(document.getElementById('endChainage').value),
                remarks: document.getElementById('remarks').value
            };
            
            app.showLoading();
            try {
                const result = await app.addRoadDetail(data);
                
                if (result.success) {
                    app.showAlert('Configuration added successfully', 'success');
                    app.hideModal('addDetailModal');
                    viewDetails(currentSegment.segment_id); // Refresh
                } else {
                    app.showAlert(result.message || 'Failed to add configuration', 'error');
                }
                app.hideLoading();
            } catch (error) {
                app.hideLoading();
                app.showAlert('Error: ' + error.message, 'error');
            }
        }

        async function deleteDetail(detailId) {
            if (!confirm('Are you sure you want to delete this configuration?')) return;
            
            app.showLoading();
            try {
                const result = await app.deleteRoadDetail(detailId);
                
                if (result.success) {
                    app.showAlert('Configuration deleted successfully', 'success');
                    viewDetails(currentSegment.segment_id); // Refresh
                } else {
                    app.showAlert(result.message || 'Failed to delete configuration', 'error');
                }
                app.hideLoading();
            } catch (error) {
                app.hideLoading();
                app.showAlert('Error: ' + error.message, 'error');
            }
        }

        // Segment CRUD Functions
        function addLaneConfigRow(configId = '', startChainage = '', endChainage = '', remarks = '', detailId = '', startLat = '', startLng = '', endLat = '', endLng = '') {
            const container = document.getElementById('laneConfigContainer');
            const rowId = `laneConfig_${laneConfigCounter++}`;
            
            const configOptions = allConfigurations.map(config => 
                `<option value="${config.config_id}" ${config.config_id == configId ? 'selected' : ''}>
                    ${config.config_name}
                </option>`
            ).join('');
            
            const row = document.createElement('div');
            row.id = rowId;
            row.className = 'lane-config-row';
            row.style.cssText = 'margin-bottom: 1rem; padding: 1rem; background: var(--light); border-radius: 0.5rem; border: 1px solid var(--border-color);';
            
            row.innerHTML = `
                <input type="hidden" class="lane-detail-id" value="${detailId}">
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 0.5rem; margin-bottom: 0.5rem; align-items: start;">
                    <div>
                        <label style="font-size: 0.85rem; color: var(--secondary-color); display: block; margin-bottom: 0.25rem;">Lane Type *</label>
                        <select class="form-control lane-config-type" required>
                            <option value="">Select Lane Type...</option>
                            ${configOptions}
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.85rem; color: var(--secondary-color); display: block; margin-bottom: 0.25rem;">Start (km) *</label>
                        <input type="number" step="0.001" class="form-control lane-start-chainage" 
                               value="${startChainage}" placeholder="0.000" required min="0" max="10000">
                    </div>
                    <div>
                        <label style="font-size: 0.85rem; color: var(--secondary-color); display: block; margin-bottom: 0.25rem;">End (km) *</label>
                        <input type="number" step="0.001" class="form-control lane-end-chainage" 
                               value="${endChainage}" placeholder="0.000" required min="0" max="10000">
                    </div>
                    <div style="align-self: end;">
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeLaneConfigRow('${rowId}')" title="Remove">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <div>
                        <label style="font-size: 0.85rem; color: var(--secondary-color); display: block; margin-bottom: 0.25rem;">Start Latitude</label>
                        <input type="number" step="0.000001" class="form-control lane-start-lat" 
                               value="${startLat}" placeholder="11.127123" min="-90" max="90">
                    </div>
                    <div>
                        <label style="font-size: 0.85rem; color: var(--secondary-color); display: block; margin-bottom: 0.25rem;">Start Longitude</label>
                        <input type="number" step="0.000001" class="form-control lane-start-lng" 
                               value="${startLng}" placeholder="78.656891" min="-180" max="180">
                    </div>
                    <div>
                        <label style="font-size: 0.85rem; color: var(--secondary-color); display: block; margin-bottom: 0.25rem;">End Latitude</label>
                        <input type="number" step="0.000001" class="form-control lane-end-lat" 
                               value="${endLat}" placeholder="11.234567" min="-90" max="90">
                    </div>
                    <div>
                        <label style="font-size: 0.85rem; color: var(--secondary-color); display: block; margin-bottom: 0.25rem;">End Longitude</label>
                        <input type="number" step="0.000001" class="form-control lane-end-lng" 
                               value="${endLng}" placeholder="78.789012" min="-180" max="180">
                    </div>
                </div>
                <div>
                    <label style="font-size: 0.85rem; color: var(--secondary-color); display: block; margin-bottom: 0.25rem;">Remarks</label>
                    <input type="text" class="form-control lane-remarks" 
                           value="${remarks}" placeholder="Additional notes (optional)">
                </div>
            `;
            
            container.appendChild(row);
        }

        function removeLaneConfigRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
            }
        }

        function clearLaneConfigRows() {
            document.getElementById('laneConfigContainer').innerHTML = '';
            laneConfigCounter = 0;
        }

        function showAddSegmentModal() {
            // Check if user is authenticated
            if (!checkAuthForModification()) {
                return;
            }
            
            // Clear form
            document.getElementById('segmentId').value = '';
            document.getElementById('segmentNhId').value = '';
            document.getElementById('segmentDivisionId').value = '';
            document.getElementById('segmentDescription').value = '';
            document.getElementById('segmentStartChainage').value = '';
            document.getElementById('segmentEndChainage').value = '';
            document.getElementById('segmentStartLatitude').value = '';
            document.getElementById('segmentStartLongitude').value = '';
            document.getElementById('segmentEndLatitude').value = '';
            document.getElementById('segmentEndLongitude').value = '';
            document.getElementById('segmentStatus').value = 'active';
            
            // Set modal title and button
            document.getElementById('segmentModalTitle').textContent = 'Add New Segment';
            document.querySelector('#segmentForm button[type="submit"]').textContent = 'Add Segment';
            
            app.showModal('addSegmentModal');
        }

        async function editSegment(segmentId) {
            // Check if user is authenticated
            if (!checkAuthForModification()) {
                return;
            }
            
            app.showLoading();
            try {
                // Fetch segment data using app.apiCall to include JWT token
                const segmentResult = await app.apiCall(`/api/segments/${segmentId}`, 'GET');
                
                if (segmentResult.success && segmentResult.data) {
                    const segment = segmentResult.data;
                    
                    // Populate form
                    document.getElementById('segmentId').value = segment.segment_id;
                    document.getElementById('segmentNhId').value = segment.nh_id;
                    document.getElementById('segmentDivisionId').value = segment.division_office_id;
                    document.getElementById('segmentDescription').value = segment.segment_name || '';
                    document.getElementById('segmentStartChainage').value = segment.start_chainage || '';
                    document.getElementById('segmentEndChainage').value = segment.end_chainage || '';
                    document.getElementById('segmentStartLatitude').value = segment.start_latitude || '';
                    document.getElementById('segmentStartLongitude').value = segment.start_longitude || '';
                    document.getElementById('segmentEndLatitude').value = segment.end_latitude || '';
                    document.getElementById('segmentEndLongitude').value = segment.end_longitude || '';
                    document.getElementById('segmentStatus').value = segment.status || 'active';
                    
                    // Set modal title and button
                    document.getElementById('segmentModalTitle').textContent = 'Edit Segment';
                    document.querySelector('#segmentForm button[type="submit"]').textContent = 'Update Segment';
                    
                    app.showModal('addSegmentModal');
                } else {
                    app.showAlert(segmentResult.message || 'Failed to load segment data', 'error');
                }
                app.hideLoading();
            } catch (error) {
                app.hideLoading();
                app.showAlert('Error loading segment: ' + error.message, 'error');
            }
        }

        function editSegmentFromDetails() {
            // Edit the current segment being viewed in details modal
            if (currentSegment && currentSegment.segment_id) {
                editSegment(currentSegment.segment_id);
            }
        }

        async function deleteSegment(segmentId, nhNumber) {
            // Check if user is authenticated
            if (!checkAuthForModification()) {
                return;
            }
            
            if (!confirm(`Are you sure you want to delete segment for ${nhNumber}?\nThis will also delete all associated road details.`)) {
                return;
            }
            
            app.showLoading();
            try {
                // Use app.apiCall to include JWT token
                const result = await app.apiCall(`/api/segments/${segmentId}`, 'DELETE');
                
                if (result.success) {
                    app.showAlert('Segment deleted successfully', 'success');
                    loadPage(); // Refresh the list
                } else {
                    app.showAlert(result.message || 'Failed to delete segment', 'error');
                }
                app.hideLoading();
            } catch (error) {
                app.hideLoading();
                app.showAlert('Error deleting segment: ' + error.message, 'error');
            }
        }

        async function handleSegmentSubmit(event) {
            event.preventDefault();
            
            console.log('Form submitted');
            
            // Get form data
            const segmentId = document.getElementById('segmentId').value;
            const nhId = parseInt(document.getElementById('segmentNhId').value);
            const divisionId = parseInt(document.getElementById('segmentDivisionId').value);
            const description = document.getElementById('segmentDescription').value.trim();
            const startChainage = parseFloat(document.getElementById('segmentStartChainage').value);
            const endChainage = parseFloat(document.getElementById('segmentEndChainage').value);
            const startLat = document.getElementById('segmentStartLatitude').value;
            const startLng = document.getElementById('segmentStartLongitude').value;
            const endLat = document.getElementById('segmentEndLatitude').value;
            const endLng = document.getElementById('segmentEndLongitude').value;
            const status = document.getElementById('segmentStatus').value;
            
            console.log('Form data:', { segmentId, nhId, divisionId, description, startChainage, endChainage, startLat, startLng, endLat, endLng, status });
            
            // Validate
            if (!nhId || isNaN(nhId)) {
                app.showAlert('Please select a National Highway', 'error');
                return;
            }
            if (!divisionId || isNaN(divisionId)) {
                app.showAlert('Please select a Division Office', 'error');
                return;
            }
            if (isNaN(startChainage) || isNaN(endChainage)) {
                app.showAlert('Please enter valid chainage values', 'error');
                return;
            }
            if (endChainage <= startChainage) {
                app.showAlert('End chainage must be greater than start chainage', 'error');
                return;
            }
            
            // Build remarks with coordinates if provided
            let remarksData = description;
            if (startLat || startLng || endLat || endLng) {
                const coords = {
                    start: { lat: startLat || null, lng: startLng || null },
                    end: { lat: endLat || null, lng: endLng || null }
                };
                remarksData += '\n[COORDS]' + JSON.stringify(coords);
            }
            
            const data = {
                nh_id: nhId,
                division_id: divisionId,
                segment_description: description,
                start_chainage: startChainage,
                end_chainage: endChainage,
                start_latitude: startLat ? parseFloat(startLat) : null,
                start_longitude: startLng ? parseFloat(startLng) : null,
                end_latitude: endLat ? parseFloat(endLat) : null,
                end_longitude: endLng ? parseFloat(endLng) : null,
                status: status
            };
            
            console.log('Sending data:', data);
            
            app.showLoading();
            try {
                let result;
                let savedSegmentId = segmentId;
                
                if (segmentId) {
                    console.log('Updating segment:', segmentId);
                    // Update existing segment using app.apiCall to include JWT token
                    result = await app.apiCall(`/api/segments/${segmentId}`, 'PUT', data);
                } else {
                    console.log('Creating new segment');
                    // Create new segment using app.apiCall to include JWT token
                    result = await app.apiCall('/api/segments', 'POST', data);
                    // Get the new segment ID from response if creating
                    if (result.success && result.data && result.data.segment_id) {
                        savedSegmentId = result.data.segment_id;
                    }
                }
                
                console.log('API result:', result);
                
                if (result.success) {
                    app.showAlert(segmentId ? 'Segment updated successfully' : 'Segment created successfully', 'success');
                    app.hideModal('addSegmentModal');
                    
                    // If editing from details modal, refresh the details view
                    if (segmentId && currentSegment && currentSegment.segment_id == segmentId) {
                        viewDetails(segmentId);
                    }
                    
                    loadPage(); // Refresh the list
                } else {
                    console.error('API error:', result.message);
                    app.showAlert(result.message || 'Failed to save segment', 'error');
                }
                app.hideLoading();
            } catch (error) {
                console.error('Exception:', error);
                app.hideLoading();
                app.showAlert('Error saving segment: ' + error.message, 'error');
            }
        }

        // Check authentication before allowing add/edit operations
        function checkAuthForModification() {
            if (!app.isAuthenticated()) {
                app.showAlert('Please log in to add or modify segments', 'error');
                setTimeout(() => {
                    window.location.href = '/index.html';
                }, 2000);
                return false;
            }
            return true;
        }

        // Load page data (public access for viewing)
        loadPage();
    </script>
</body>
</html>
